<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	 <link href="style.css" rel="stylesheet">
	<script type="text/javascript">
	/*
		все переменные с _x , все id с __x
	*/
		const _mask = 'n_';
		let _globalHashTagsSet = new Set();
		let _currTags = new Set();

		function init(){
			if (localStorage.length <= 0){
				localStorage.setItem('maxKey','1');
			}
		}

		function deleteNodes(ID){
			
	        let _node = document.getElementById(ID);
			while (_node.firstChild) {
			    _node.removeChild(_node.firstChild);
			}
		}

		function showNotesList(){
			//delete previous nodes in DOM
			deleteNodes("__base-div__forms");
			let _notesListDiv = document.createElement('div');
			_notesListDiv.id = "__forms__notesList";
			_notesListDiv.className = "notesList";
			//add div into DOM
			document.getElementById("__base-div__forms").appendChild(_notesListDiv);
			//add ul into div
			let _newUl = document.createElement('ul');
			_newUl.id = "__newUl";
			document.getElementById("__forms__notesList").appendChild(_newUl);
			let ul = document.getElementById("__newUl");
			//verify localstorage length
			if (localStorage.length > 1) { //1 - maxID, 2 - tags array, change on 2 later
				//add li into ul in loop
				for (let i = 0; i < localStorage.length; i++) {
					//mask verify
					let _key = localStorage.key(i);
					if (_key.indexOf(_mask) == 0) {
						let _newLi = document.createElement('li');
						_newLi.id = _key;
						_newLi.className = "noteListItem";
						_newLi.innerHTML = localStorage.getItem(_key);	
						_newLi.addEventListener('click', function(){note(_key);});
						ul.appendChild(_newLi);	
					}					
				}	
			}
		}		
		
		function note(flg){		
			/*
				flags: 
				undefined- new note
				noteID - show note
			*/	
			//delete previous childs DOM 
			deleteNodes("__base-div__forms");
			let _newTextArea = document.createElement('div');
  			_newTextArea.id = "__forms__textarea";
  			_newTextArea.className = "textarea_div";
  			_newTextArea.contentEditable = false;  			
  			_newTextArea.setAttribute("placeHolder","enter note text");	  			
			document.getElementById("__base-div__forms").appendChild(_newTextArea);
			let _tagsArea = document.createElement('p');
			_tagsArea.id ="__tagsArea";
			_tagsArea.className = "tagsArea";
			document.getElementById("__base-div__forms").appendChild(_tagsArea);
			//breakpoint: flg view|new note
			if (flg == undefined){ //new note
				_newTextArea.contentEditable = true;
				addSaveButton();				
				parseCurrTags();				
			} else { //view note
				addBtnDel(flg);
				_newTextArea.innerHTML = localStorage.getItem(flg);				
				parseTags(_newTextArea.innerHTML);
				_newTextArea.addEventListener('dblclick', function(){ 
					//edit onclick
					document.getElementById("__forms__textarea").contentEditable = true;
					addSaveButton(flg);
					
					parseCurrTags();
				});
			}			
		}	

		function addBtnDel(flg){
			let _newBtnDel = document.createElement('button');
			_newBtnDel.innerHTML = 'delete';
			_newBtnDel.addEventListener('click', function(){localStorage.removeItem(flg); showNotesList();});
			_newBtnDel.className = "btn";
			document.getElementById("__base-div__forms").appendChild(_newBtnDel);
		}

		function addSaveButton(flg){// flags new|edit  
			//parseInputTags();
			let _newBtnSave = document.createElement('button');
			_newBtnSave.innerHTML = 'save';			
			if (flg == undefined){// new note
				_newBtnSave.addEventListener('click',function(){
					saveNote();
					//hide btn, div edit = false
					document.getElementById("__forms__textarea").contentEditable = false;
					document.getElementById("__base-div__forms").removeChild(document.getElementById("__base-div__forms").lastChild);
				});
			} else {
				_newBtnSave.addEventListener('click',function(){
					saveNote(flg);
					//hide btn, div edit = false
					document.getElementById("__forms__textarea").contentEditable = false;
					document.getElementById("__base-div__forms").removeChild(document.getElementById("__base-div__forms").lastChild);
				});
			}			
			_newBtnSave.className = "btn";
			document.getElementById("__base-div__forms").appendChild(_newBtnSave);
		}

		function saveNote(flg){//flags new|edit, if edit => add localstorage key = flg id
			//if flg == undefined = new note add
			if (flg == undefined) {//new note save
				let num = parseInt(localStorage.getItem('maxKey'),10);
				num++;
				localStorage.setItem(_mask + num,document.getElementById("__forms__textarea").innerHTML);
				localStorage.setItem('maxKey', num);	
				//save tags from global to localstorage
			} else {//edit note save
				localStorage.setItem(flg, document.getElementById("__forms__textarea").innerHTML);
				//save tags from global to localstorage
			}			
		}

		function parseTagsInArray(){
			//put tags in global variable from localstorage
		}

		

		function saveGlobalTags(){
			//save to localstorage
		}

		function clearTempSet(){
			for (let item of _currTags) _currTags.delete(item);			
		}

		function parseTags(text){
			clearTempSet();
			let _tagsArray =[];
					_tagsArray = text;
					_tagsArray = _tagsArray.split(' ');
					for (let i = 0; i < _tagsArray.length; i++){
						if (_tagsArray[i].indexOf('#') == 0 ){
							//add tag to global-temp array	
							_currTags.add(_tagsArray[i]);
							//add to global tags
						}
					}
					//alert(Array.from(_currTags));
					//вывод тегов в поле

					document.getElementById("__tagsArea").innerHTML = Array.from(_currTags);
		}

		function parseCurrTags(){
			//in opened note
			let input = document.querySelector('.textarea_div');
			input.addEventListener('keyup', function (event) {
				if (event.keyCode == 32){
					let text = this.textContent;
					parseTags(text);
				}
			});			 
		}

		/*
		let input;
		function parseInputTags(){
			let input = document.querySelector('.textarea_div');
			input.addEventListener('keyup', function (event) {
			    // забираем только текст, без тегов
			    //if ((event.keyCode != 37) && (event.keyCode != 39) && (event.keyCode != 32)){
			    //if (event.keyCode == 32){
			    	var text = this.textContent;
				    // заменяем
				    var highlighted = text.replace(/(#\w+)/g, '<span class="hashtag">$1</span>');
				    // обновляем содержимое
				    this.innerHTML = highlighted;
				    // установка курсора в конец строки
				    //placeCaretAtEnd(this);
			    //}
			    
			});		
		}		

		function placeCaretAtEnd(el) {
		    el.focus();
		    if (typeof window.getSelection != "undefined" &&
		        typeof document.createRange != "undefined"
		    ) {
		        var range = document.createRange();
		        range.selectNodeContents(el);
		        range.collapse(false);
		        var sel = window.getSelection();
		        sel.removeAllRanges();
		        sel.addRange(range);
		    } else if (typeof document.body.createTextRange != "undefined") {
		        var textRange = document.body.createTextRange();
		        textRange.moveToElementText(el);
		        textRange.collapse(false);
		        textRange.select();
		    }
		}
*/

		init();
	</script>

	<title>Notes</title>
</head>
<body>
	<div class="base-div">
		<button onclick="note()">new note</button>
		<button onclick="showNotesList()">all notes</button>
		<button>etc</button>
		<div class="base-div__forms" id="__base-div__forms">
			
		</div>
		

	</div>

</body>
</html>